<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Web Viewer</title>
</head>
<body>
    <h1>Web Viewer</h1>
    <!-- Example: udpsrc port=5000 caps="application/x-rtp" ! decodebin -->
    <input id="pipeline" type="text" placeholder="gstreamer pipeline" style="width:80%" />
    <button id="start">Start</button>
    <button id="stop">Stop</button>
    <div>
        <img id="stream" style="max-width:100%; display:none;" />
    </div>
    <pre id="log" style="background:#eee;max-height:200px;overflow:auto"></pre>
    <script>
    document.getElementById('start').onclick = async () => {
        const pipeline = document.getElementById('pipeline').value;
        await fetch('/stream/start', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({pipeline})
        });
        const img = document.getElementById('stream');
        img.style.display = 'block';
        refreshImage();
        if (window.refreshInterval) clearInterval(window.refreshInterval);
        window.refreshInterval = setInterval(refreshImage, 500);
        updateLog();

    };
    document.getElementById('stop').onclick = async () => {
        await fetch('/stream/stop', {method: 'POST'});
        const img = document.getElementById('stream');
        img.src = '';
        img.style.display = 'none';
        if (window.refreshInterval) clearInterval(window.refreshInterval);
        updateLog();
    };

    async function updateLog() {
        const logText = await fetch('/stream/log').then(r => r.text());
        document.getElementById('log').textContent = logText;
    }

    function refreshImage() {
        const img = document.getElementById('stream');
        img.src = '/video?t=' + Date.now();
    }

    setInterval(updateLog, 2000);
    </script>
</body>
</html>
