<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <title>Suivi Drone sur Windy</title>

    <!-- Leaflet core -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"></script>

    <!-- Windy -->
    <script src="https://api.windy.com/assets/map-forecast/libBoot.js"></script>

    <!-- Plugin pour faire pivoter le marqueur -->
    <script src="https://unpkg.com/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.js"></script>

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #windy {
            position: absolute;
            top: 10px;
            bottom: 10px;
            left: 10px;
            right: 10px;
            border: 5px solid #c8c8c8;
            border-radius: 10px;
            background: #fff;
        }

        #loading {
            position: absolute;
            top: 10px;
            bottom: 10px;
            left: 10px;
            right: 10px;
            border: 5px solid #c8c8c8;
            border-radius: 10px;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }
    </style>
</head>
<body>
    <div id="windy"></div>
    <div id="loading">Loading map…</div>

    <script>
        // CONFIG WINDY
        const windy_options = {
            key: 'SSUGxhvXMZUTgav1QfuYZG7smD3vaEPB',
            lat: -18.91368,
            lon: 47.53613,
            zoom: 7
        };

        let map;
        const loadingDiv = document.getElementById('loading');
        let droneMarker = null;

        // Initialisation de Windy
        windyInit(windy_options, function (windyAPI) {
            map = windyAPI.map;
            map.options.maxZoom = 17;

            // Masquer le message de chargement
            loadingDiv.style.display = 'none';

            // Force le calque "wind"
            windyAPI.store.set('overlay', 'wind');

            // Ajoute l’attribution Windy.com en permanence
            map.attributionControl.addAttribution(
                'Données météo © <a href="https://www.windy.com" target="_blank">Windy.com</a>'
            );

            // Redessine et déclenche zoomend pour rafraîchir l’UI
            setTimeout(function () {
                map.invalidateSize();
                map.fire('zoomend');
            }, 500);

            // Cercles de zone
            L.circle([-23.3470407, 47.5962614], { color: 'red', fillOpacity: 0, radius: 120000 }).addTo(map);
            L.circle([-22.9120275, 44.5280449], { color: 'blue', fillOpacity: 0, radius: 120000 }).addTo(map);
            L.circle([-19.672116, 47.314187], { color: 'green', fillOpacity: 0, radius: 120000 }).addTo(map);

            // Barre d'échelle
            L.control.scale().addTo(map);

            // Lancer le polling
            setInterval(fetchAndUpdateDrone, 1000);
            fetchAndUpdateDrone();
        });

        // Icône SVG pour le drone
        function createDroneIcon(yaw) {
            return L.divIcon({
                html: `
          <svg width="40" height="40" viewBox="0 0 576 512"
               style="transform: rotate(${yaw - 90}deg);">
            <path fill="#000000"
                  d="M482.3 192c34.2 0 93.7 29 93.7 64c0 36-59.5 64-93.7 64
                     l-116.6 0L265.2 495.9c-5.7 10-16.3 16.1-27.8 16.1
                     l-56.2 0c-10.6 0-18.3-10.2-15.4-20.4l49-171.6L112 320
                     68.8 377.6c-3 4-7.8 6.4-12.8 6.4l-42 0c-7.8 0-14-6.3-14-14
                     c0-1.3 .2-2.6 .5-3.9L32 256 .5 145.9c-.4-1.3-.5-2.6-.5-3.9
                     c0-7.8 6.3-14 14-14l42 0c5 0 9.8 2.4 12.8 6.4L112 192
                     l102.9 0-49-171.6C162.9 10.2 170.6 0 181.2 0l56.2 0
                     c11.5 0 22.1 6.2 27.8 16.1L365.7 192l116.6 0z"/>
          </svg>`,
                className: '',
                iconSize: [40, 40]
            });
        }

        // Récupération et mise à jour
        async function fetchAndUpdateDrone() {
            try {
                const res = await fetch('/drone-position');
                if (res.status === 200) {
                    const { lat, lon, yaw } = await res.json();
                    if (!droneMarker) {
                        droneMarker = L.marker([lat, lon], {
                            icon: createDroneIcon(yaw),
                            rotationOrigin: 'center'
                        }).addTo(map);
                        droneMarker.bindPopup('Drone connecté');
                    } else {
                        droneMarker.setLatLng([lat, lon]);
                        droneMarker.setIcon(createDroneIcon(yaw));
                    }
                }
            } catch (err) {
                console.error('Erreur fetch /drone-position :', err);
            }
        }
    </script>
</body>
</html>
